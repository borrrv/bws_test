# Тестовое задание для Betting Software

## Система состоит из двух сервисов, который взаимодействуют между собой по gRPC и RabbitMQ
## Сервисы
## 1. Сервис line-provider отвечает за сервис событий.(```http://localhost:3000``)
## API сервиса line-provider:
- (DELETE) Удаление события по его id.
```/api/event/{_id}```
- (GET) Получение события по его id.
```/api/event/{_id}```
- (PATCH) Обновление статуса события по его id.
```/api/event/{_id}```
- (GET) Получение списка всех событий
```/api/event/all/```
- (GET) Получение списка событий, на которые можно совершить ставку.
```/api/event/```
- (POST) Создать событие.

### В данном сервисе открыт gRPC-сервер для взаимодействия с сервисом bet-maker
### Для gRPC реализованы следующие методы

- ```GetEventAll```: Получение списка всех событий.
- ```GetEvent```: Получение только валидных событий (Подходят по дедлайну по времени).
- ```GetEventById```: Получение события по id.
- ```EventCheckTime```: Проверка проходит ли у одного события дедлайн по времени.

## 2. Сервис bet-maker 
## Сервис bet-maker отвечает за ставки.
## API сервиса bet-maker (```http://localhost:4000``):

- (GET) Возвращает список всех событий.
```/api/events/all```
- (GET) Возвращает список событий, на которые можно совершить ставку. Таковыми считаются все события, для которых ещё не наступил дедлайн для ставок
```/api/events/```

  
- (POST) Совершает ставку на событие. Проверяет на наличие события и попадание в дедлайны.
```/api/bets/```
- (GET) Возвращает историю всех сделанных ставок.
```/api/bets/```


gRPC используется для получения событий и их валидации.
RabbitMQ используется для критически важных моментов, которые нельзя терять. Когда изменяется статус события, сообщение по брокеру доходит и до ставки.

## Запуск

1. ```cd bws_test```
2. ```docker compose up -d --build```

Swagger доступен по адресам
```http://localhost:3000/docs```: line-provider
```http://localhost:4000/docs```: bet-maker

При запуске создается 10 ставок и 10 событий

У событий дедлайн выбирается рандомно от 20 до 60

3. Посмотреть список всех событий ```http://localhost:4000/api/events/all```
4. Через некоторое время можно посмотреть ```http://localhost:3000/api/events```
5. Попробовать сделать ставку на событие, которого не существует или прошел дедлайн```http://localhost:4000/api/bets```
5. Добавить событие ```http://localhost:3000/api/event/```
6. Проверить доступные события на ставку ```http://localhost:4000/api/events/```
7. Сделать ставку на это событие ```http://localhost:4000/api/bets/``` (POST)
8. Проверить все ставки ```http://localhost:4000/api/bets/``` (GET) (Будет много ставок, так как при запуске автоматически добавляются ставки)
9. Изменить статус события ```http://localhost:3000/api/event/``` (PATCH)
```  
1: незавершённое,
2: завершено выигрышем первой команды,
3: завершено выигрышем второй команды и, соответственно, поражением первой
```
10. Проверить все ставки ```http://localhost:4000/api/bets/. Статус ставки поменяется


# Стек
- Python3.11
- FastAPI
- Sqlalchemy
- gRPC
- RabbitMQ
- pre-commit
- aio_pika
- orjson

## В проекте применялся pre-commit c black, flake8 и isort, также использован быстрый orjson.
